ANNO=$1

[ ! -d bigWig ] && ( mkdir bigWig )
for GENO in $(awk '$1~"TS"{print $6}' $ANNO | sort -u);
do
    echo $GENO
    awk -v "geno=$GENO" '$6 == geno' $ANNO > tmp.txt
    for TIME in $(cut -f5 tmp.txt | sort -f1,1n -u);
    do
	echo "  $TIME"
	BAMS=$(awk -v "time=$TIME" 'BEGIN{ORS=" "}$5 == time{print "STAR/" $1 ".Sorted.out.bam"}' tmp.txt)
	OUT=$(echo "${GENO}.${TIME}")
	if [ ! -f STAR/$OUT.bam ]; then
	echo "    Merging replicas - $OUT"
	    samtools merge --threads 30 STAR/$OUT.bam $BAMS
	    samtools index STAR/$OUT.bam
	fi
	echo "    Making BW file"
	samtools view -b -f 128 -F 16 STAR/$OUT.bam > STAR/$OUT.fwd1.bam
	samtools view -b -f 80 STAR/$OUT.bam > STAR/$OUT.fwd2.bam
	samtools merge -f STAR/$OUT.fwd.bam STAR/$OUT.fwd1.bam STAR/$OUT.fwd2.bam
	samtools index STAR/$OUT.fwd.bam
	samtools view -b -f 144 STAR/$OUT.bam > STAR/$OUT.rev1.bam
	samtools view -b -f 64 -F 16 STAR/$OUT.bam > STAR/$OUT.rev2.bam
	samtools merge -f STAR/$OUT.rev.bam STAR/$OUT.rev1.bam STAR/$OUT.rev2.bam
	samtools index STAR/$OUT.rev.bam
	
	bamCoverage -p "max" \
		    --binSize 1 \
		    --skipNonCoveredRegions \
		    -b STAR/$OUT.rev.bam \
		    -o bigWig/$OUT.rev.bw 2> bigWig/$OUT.rev.log

	bamCoverage -p "max" \
		    --binSize 1 \
		    --skipNonCoveredRegions \
		    -b STAR/$OUT.fwd.bam \
		    -o bigWig/$OUT.fwd.bw 2> bigWig/$OUT.fwd.log

	rm STAR/$OUT.fwd*.bam
	rm STAR/$OUT.rev*.bam
    done
done
